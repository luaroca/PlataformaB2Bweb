<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detalle del Producto | Provecta</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="detalle_producto.css">
</head>

<body>
    <!-- Navbar -->
    <header class="navbar">
        <a href="index.html" class="logo">Provecta</a>
        <div class="search-container">
            <div class="search-bar">
                <input type="text" placeholder="Buscar productos industriales..." />
                <button>üîç</button>
            </div>
        </div>
        <nav class="nav-links">
            <a href="login.html" class="nav-btn primary">Iniciar Sesi√≥n</a>
            <a href="registro.html" class="nav-btn outline">Registrarse</a>
        </nav>
    </header>

    <!-- Hero Section -->
    <section class="hero-section">
        <h1 class="product-title" id="titulo"></h1>
    </section>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Product Section -->
        <div class="product-section">
            <div class="product-grid">
                <!-- Gallery -->
                <div class="gallery-container">
                    <div class="thumbnail-grid">
                        <img class="thumbnail active" id="img_1" alt="Vista 1">
                        <img class="thumbnail" id="img_2" alt="Vista 2">
                        <img class="thumbnail" id="img_3" alt="Vista 3">
                    </div>
                    <div class="main-image-container">
                        <img class="main-image" id="imagen_principal"
                            src="https://images.unsplash.com/photo-1581094794329-c8112a89af12?w=800"
                            alt="Motor Industrial">
                        <div class="image-overlay">
                            <button class="overlay-btn" title="Zoom">üîç</button>
                            <button class="overlay-btn" title="Compartir">üì§</button>
                            <button class="overlay-btn" title="Favorito">‚ù§Ô∏è</button>
                        </div>
                    </div>
                </div>

                <!-- Product Details -->
                <div class="product-details">
                    <div class="details-header">
                        <h2 class="details-title" id="nombre">Motor Industrial XYZ-2000</h2>
                        <p class="details-subtitle">Proveedor de confianza certificado</p>
                    </div>

                    <div class="price-section">
                        <div class="current-price" id="precio"></div>
                        <div class="old-price" id="precio_anterior"></div>
                        <div class="savings" id="porcentaje_descuento"></div>
                    </div>

                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">Proveedor</span>
                            <span class="detail-value" id="proveedor"></span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Unidad</span>
                            <span class="detail-value" id="unidad_medida">Unidad</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Origen</span>
                            <span class="detail-value" id="origen_producto">Colombia</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Entrega</span>
                            <span class="detail-value" id="tiempo_entrega">15-20 d√≠as h√°biles</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Stock</span>
                            <span class="detail-value" id="stock">25 unidades</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">M√≠n. Pedido</span>
                            <span class="detail-value" id="minimo_pedido">1 unidad</span>
                        </div>
                    </div>

                    <button class="cta-button">
                        üí¨ Contactar Proveedor
                    </button>
                </div>
            </div>
        </div>

        <!-- Bottom Sections -->
        <div class="bottom-sections">
            <!-- Related Products -->
            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">Productos Relacionados</h3>
                    <p class="section-subtitle">Otros productos que podr√≠an interesarte</p>
                </div>
                <div class="related-products-scroll" id="related-products">
                    <!-- Products will be loaded here -->
                </div>
            </div>

            <!-- Reviews Section -->
            <div class="section-card">
                <div class="section-header">
                    <h3 class="section-title">Calificaciones y Opiniones</h3>
                    <p class="section-subtitle">Lo que dicen nuestros clientes</p>
                </div>

                <div class="reviews-summary">
                    <div class="rating-overview">
                        <div class="rating-score"></div>
                        <div class="rating-stars"></div>
                        <div class="rating-label"></div>
                    </div>
                    <div class="rating-bars">
                        <div class="rating-bar-item">
                            <span>5 ‚òÖ</span>
                            <div class="rating-bar">
                                <div class="rating-bar-fill" id="bar-5"></div>
                            </div>
                            <span id="porcentaje_5"></span>
                        </div>
                        <div class="rating-bar-item">
                            <span>4 ‚òÖ</span>
                            <div class="rating-bar">
                                <div class="rating-bar-fill" id="bar-4"></div>
                            </div>
                            <span id="porcentaje_4"></span>
                        </div>
                        <div class="rating-bar-item">
                            <span>3 ‚òÖ</span>
                            <div class="rating-bar">
                                <div class="rating-bar-fill" id="bar-3"></div>
                            </div>
                            <span id="porcentaje_3"></span>
                        </div>
                        <div class="rating-bar-item">
                            <span>2 ‚òÖ</span>
                            <div class="rating-bar">
                                <div class="rating-bar-fill" id="bar-2"></div>
                            </div>
                            <span id="porcentaje_2"></span>
                        </div>
                        <div class="rating-bar-item">
                            <span>1 ‚òÖ</span>
                            <div class="rating-bar">
                                <div class="rating-bar-fill" id="bar-1"></div>
                            </div>
                            <span id="porcentaje_1"></span>
                        </div>
                    </div>
                </div>

                <div class="reviews-list" id="reviews-list">
                    <!-- Reviews will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== FUNCIONES PRINCIPALES ====================

        async function cargarDetalleProducto(productoId) {
            try {
                const response = await fetch(`/producto-detalle/${productoId}`);
                const data = await response.json();
                const producto = data.producto;

                function mostrarOCultarImagen(id, imagen) {
                    const img = document.getElementById(id);
                    if (img) {
                        if (imagen && imagen.trim() !== "") {
                            img.src = `/uploads/${imagen}`;
                            img.style.display = "block";
                        } else {
                            img.style.display = "none";
                        }
                    }
                }

                mostrarOCultarImagen("img_1", producto.imagen_principal);
                mostrarOCultarImagen("img_2", producto.imagen_secundaria1);
                mostrarOCultarImagen("img_3", producto.imagen_secundaria2);
                mostrarOCultarImagen("imagen_principal", producto.imagen_principal);

                const mainTitleElement = document.querySelector('.product-main-title');
                if (mainTitleElement) {
                    mainTitleElement.textContent = producto.nombre;
                }
                document.getElementById("titulo").textContent = producto.nombre;
                document.getElementById("nombre").textContent = producto.nombre;
                document.getElementById("proveedor").textContent = producto.proveedor_nombre;
                document.getElementById("unidad_medida").textContent = producto.unidad_medida;
                document.getElementById("origen_producto").textContent = producto.origen_producto;
                document.getElementById("tiempo_entrega").textContent = producto.tiempo_entrega;
                document.getElementById("precio").textContent = parseFloat(producto.precio).toLocaleString('es-CO');
                document.getElementById("precio_anterior").textContent = (producto.precio * 1.15).toFixed(2);
                document.getElementById("stock").textContent = producto.stock;
                document.getElementById("minimo_pedido").textContent = producto.minimo_pedido;

                calcularDescuento((producto.precio * 1.15).toFixed(2), producto.precio);
                cargarProductosRelacionados(producto.categoria, productoId);

                // ‚úÖ NUEVO: Cargar rese√±as y estad√≠sticas
                await cargarResenasYEstadisticas(productoId);

            } catch (err) {
                console.error("Error al cargar producto:", err);
            }
        }

        function calcularDescuento(precioAnterior, precioActual) {
            const diferencia = precioAnterior - precioActual;
            const porcentajeDescuento = (diferencia / precioAnterior) * 100;
            document.getElementById("porcentaje_descuento").textContent = porcentajeDescuento.toFixed(2) + "%";
        }

        // ‚úÖ FUNCI√ìN CORREGIDA: Productos relacionados
        async function cargarProductosRelacionados(categoria, id) {
            try {
                const response = await fetch(`/productos-relacionados/${categoria}/${id}`);
                const data = await response.json();
                const contenedor = document.getElementById("related-products"); // ‚úÖ ID corregido

                contenedor.innerHTML = "";

                if (data.success && data.productos.length > 0) {
                    data.productos.forEach(producto => {
                        const div = document.createElement("div");
                        div.className = "related-product-card";
                        div.innerHTML = `
                    <img src="${producto.imagen_principal ? `/uploads/${producto.imagen_principal}` : 'imagen-placeholder.jpg'}"
                        alt="${producto.nombre}" />
                    <p class="product-name">${producto.nombre}</p>
                    <p class="product-price">$${parseFloat(producto.precio).toLocaleString('es-CO')}</p>
                `;
                        div.onclick = () => {
                            localStorage.setItem("det_id_producto", producto.id);
                            location.reload();
                        };
                        contenedor.appendChild(div);
                    });
                } else {
                    contenedor.innerHTML = "<p>No hay productos relacionados.</p>";
                }
            } catch (err) {
                console.error("Error al cargar productos relacionados:", err);
            }
        }

        // ==================== FUNCIONES DE RESE√ëAS (NUEVAS) ====================

        // ‚úÖ NUEVA FUNCI√ìN: Cargar rese√±as y estad√≠sticas
        async function cargarResenasYEstadisticas(productoId) {
            try {
                // Cargar estad√≠sticas primero
                await cargarEstadisticasResenas(productoId);

                // Luego cargar las rese√±as
                await cargarResenas(productoId, 1, 5); // P√°gina 1, 5 rese√±as

            } catch (error) {
                console.error('Error al cargar rese√±as:', error);
            }
        }

        // ‚úÖ NUEVA FUNCI√ìN: Cargar estad√≠sticas de rese√±as
        async function cargarEstadisticasResenas(productoId) {
            try {
                const response = await fetch(`/resenas-estadisticas/${productoId}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.estadisticas) {
                    const stats = data.estadisticas;

                    // Actualizar resumen de calificaciones
                    actualizarResumenCalificaciones(stats);

                    // Actualizar barras de progreso
                    actualizarBarrasProgreso(stats.porcentajes);
                } else {
                    console.warn('No se encontraron estad√≠sticas o la respuesta no fue exitosa');
                    // Mostrar valores por defecto
                    const statsDefault = {
                        total_resenas: 0,
                        promedio_calificacion: 0,
                        porcentajes: { p5: 0, p4: 0, p3: 0, p2: 0, p1: 0 }
                    };
                    actualizarResumenCalificaciones(statsDefault);
                    actualizarBarrasProgreso(statsDefault.porcentajes);
                }
            } catch (error) {
                console.error('Error al cargar estad√≠sticas:', error);
                // Mostrar valores por defecto en caso de error
                const statsDefault = {
                    total_resenas: 0,
                    promedio_calificacion: 0,
                    porcentajes: { p5: 0, p4: 0, p3: 0, p2: 0, p1: 0 }
                };
                actualizarResumenCalificaciones(statsDefault);
                actualizarBarrasProgreso(statsDefault.porcentajes);
            }
        }

        // ‚úÖ NUEVA FUNCI√ìN: Actualizar resumen de calificaciones
        function actualizarResumenCalificaciones(stats) {
            const ratingScore = document.querySelector('.rating-score');
            const ratingStars = document.querySelector('.rating-stars');
            const ratingLabel = document.querySelector('.rating-label');

            if (ratingScore) {
                ratingScore.textContent = stats.promedio_calificacion.toFixed(1);
            }

            if (ratingStars) {
                ratingStars.innerHTML = renderizarEstrellas(Math.round(stats.promedio_calificacion));
            }

            if (ratingLabel) {
                ratingLabel.textContent = `Basado en ${stats.total_resenas} rese√±as`;
            }
        }

        // ‚úÖ NUEVA FUNCI√ìN: Actualizar barras de progreso
        function actualizarBarrasProgreso(porcentajes) {
            // Actualizar barras de progreso
            document.getElementById('bar-5').style.width = `${porcentajes.p5}%`;
            document.getElementById('bar-4').style.width = `${porcentajes.p4}%`;
            document.getElementById('bar-3').style.width = `${porcentajes.p3}%`;
            document.getElementById('bar-2').style.width = `${porcentajes.p2}%`;
            document.getElementById('bar-1').style.width = `${porcentajes.p1}%`;

            // Actualizar porcentajes
            document.getElementById('porcentaje_5').textContent = `${porcentajes.p5}%`;
            document.getElementById('porcentaje_4').textContent = `${porcentajes.p4}%`;
            document.getElementById('porcentaje_3').textContent = `${porcentajes.p3}%`;
            document.getElementById('porcentaje_2').textContent = `${porcentajes.p2}%`;
            document.getElementById('porcentaje_1').textContent = `${porcentajes.p1}%`;
        }

        // ‚úÖ NUEVA FUNCI√ìN: Cargar rese√±as individuales
        async function cargarResenas(productoId, page , limit) {
            try {
                const response = await fetch(`/resenas/${productoId}?page=${page}&limit=${limit}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.resenas) {
                    mostrarResenas(data.resenas);
                } else {
                    console.warn('No se encontraron rese√±as o la respuesta no fue exitosa');
                    mostrarResenas([]);
                }
            } catch (error) {
                console.log('Error al cargar rese√±as:', error);
                // Mostrar mensaje de error en el contenedor
                const contenedor = document.getElementById("reviews-list");
                if (contenedor) {
                    contenedor.innerHTML = "<p>Error al cargar las rese√±as. Por favor, intenta de nuevo m√°s tarde.</p>";
                }
            }
        }

        // ‚úÖ NUEVA FUNCI√ìN: Mostrar rese√±as en el DOM
        function mostrarResenas(resenas) {
            const contenedor = document.getElementById("reviews-list");

            if (!contenedor) return;

            contenedor.innerHTML = "";

            if (resenas.length === 0) {
                contenedor.innerHTML = "<p>No hay rese√±as disponibles para este producto.</p>";
                return;
            }

            resenas.forEach(resena => {
                const reviewDiv = document.createElement("div");
                reviewDiv.className = "review-item";

                reviewDiv.innerHTML = `
            <div class="review-header">
                <div class="reviewer-info">
                    <span class="reviewer-name">${resena.usuario_nombre}</span>
                    <div class="reviewer-country">
                        <img src="${resena.bandera_url}" alt="${resena.pais}" width="16" height="12">
                        <span>${resena.pais}</span>
                    </div>
                </div>
                <div class="review-rating">
                    ${renderizarEstrellas(resena.calificacion)}
                </div>
            </div>
            <div class="review-content">
                <p>${resena.comentario}</p>
                ${resena.imagen_url ? `<img src="${resena.imagen_url}" alt="Imagen de rese√±a" class="review-image">` : ''}
            </div>
            <div class="review-date">
                ${resena.fecha_formateada}
            </div>
        `;

                contenedor.appendChild(reviewDiv);
            });
        }

        // ‚úÖ FUNCI√ìN EXISTENTE MEJORADA: Renderizar estrellas
        function renderizarEstrellas(cantidad) {
            const estrellas = [];
            for (let i = 1; i <= 5; i++) {
                if (i <= cantidad) {
                    estrellas.push('‚òÖ'); // Estrella llena
                } else {
                    estrellas.push('‚òÜ'); // Estrella vac√≠a
                }
            }
            return estrellas.join('');
        }

        // ==================== INICIALIZACI√ìN ====================

        const id_producto = localStorage.getItem("det_id_producto");
        console.log(id_producto);
        if (id_producto) {
            cargarDetalleProducto(id_producto);
        } else {
            console.warn("No se encontr√≥ ID de producto en localStorage. Cargando un ID de ejemplo o redirigiendo.");
        }

        // ‚úÖ EVENTO DOM CORREGIDO
        document.addEventListener('DOMContentLoaded', () => {
            const img1 = document.getElementById('img_1');
            const img2 = document.getElementById('img_2');
            const img3 = document.getElementById('img_3');
            const imagenPrincipal = document.getElementById('imagen_principal');

            const setMainImage = (src, clickedImg) => {
                if (!imagenPrincipal) return;
                imagenPrincipal.src = src;
                document.querySelectorAll('.thumbnail').forEach(img => img.classList.remove('active')); // ‚úÖ Corregido
                if (clickedImg) {
                    clickedImg.classList.add('active'); // ‚úÖ Corregido
                }
            };

            const thumbnailClickHandler = (event) => {
                setMainImage(event.target.src, event.target);
            };

            if (img1) img1.addEventListener('click', thumbnailClickHandler);
            if (img2) img2.addEventListener('click', thumbnailClickHandler);
            if (img3) img3.addEventListener('click', thumbnailClickHandler);

            const initialSet = () => {
                setTimeout(() => {
                    if (img1 && img1.style.display !== 'none' && img1.src && img1.src !== window.location.href) {
                        setMainImage(img1.src, img1);
                    } else if (img2 && img2.style.display !== 'none' && img2.src && img2.src !== window.location.href) {
                        setMainImage(img2.src, img2);
                    } else if (img3 && img3.style.display !== 'none' && img3.src && img3.src !== window.location.href) {
                        setMainImage(img3.src, img3);
                    } else if (imagenPrincipal) {
                        imagenPrincipal.src = '/uploads/default.png';
                    }
                }, 100);
            };

            initialSet();
        });
    </script>
</body>

</html>